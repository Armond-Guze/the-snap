name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Lint and Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NEXT_TELEMETRY_DISABLED: '1'
      CI: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: NODE_OPTIONS=--max-old-space-size=4096 npm run lint

      - name: Typecheck
        run: npx tsc --noEmit

  unit_tests:
    name: Unit Tests
    needs: checks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NEXT_TELEMETRY_DISABLED: '1'
      CI: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Detect unit test script
        id: detect
        run: |
          node -e 'const {appendFileSync}=require("node:fs"); const scripts=require("./package.json").scripts||{}; appendFileSync(process.env.GITHUB_OUTPUT, `has_unit=${Boolean(scripts["test:unit"])}\n`);'

      - name: Run unit tests
        if: steps.detect.outputs.has_unit == 'true'
        run: npm run test:unit

      - name: No unit tests configured
        if: steps.detect.outputs.has_unit != 'true'
        run: echo "Skipping unit tests: add a test:unit script to package.json to enable this stage."

  integration_tests:
    name: Integration Tests
    needs: checks
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      NEXT_TELEMETRY_DISABLED: '1'
      CI: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Detect integration test script
        id: detect
        run: |
          node -e 'const {appendFileSync}=require("node:fs"); const scripts=require("./package.json").scripts||{}; appendFileSync(process.env.GITHUB_OUTPUT, `has_integration=${Boolean(scripts["test:integration"])}\n`);'

      - name: Run integration tests
        if: steps.detect.outputs.has_integration == 'true'
        run: npm run test:integration

      - name: No integration tests configured
        if: steps.detect.outputs.has_integration != 'true'
        run: echo "Skipping integration tests: add a test:integration script to package.json to enable this stage."

  build:
    name: Build
    needs:
      - checks
      - unit_tests
      - integration_tests
    if: >
      always() &&
      needs.checks.result == 'success' &&
      (needs.unit_tests.result == 'success' || needs.unit_tests.result == 'skipped') &&
      (needs.integration_tests.result == 'success' || needs.integration_tests.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      NEXT_TELEMETRY_DISABLED: '1'
      CI: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
